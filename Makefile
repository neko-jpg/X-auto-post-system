# =============================================================================
# X Auto-Post System - Makefile
# =============================================================================
# プログラミング初心者でも簡単にセットアップ・起動できるようにするためのMakefile
#
# 使い方:
#   make help   - コマンド一覧を表示
#   make setup  - 依存関係をインストール
#   make app    - アプリを起動
# =============================================================================

# このMakefileがあるディレクトリを基準にする（どこから実行しても動作する）
ROOT_DIR := $(dir $(abspath $(lastword $(MAKEFILE_LIST))))
NEXT_APP := $(ROOT_DIR)next-app

# シェル設定
SHELL := cmd.exe

.PHONY: help setup app dev run build clean reset test status check-node legacy

# デフォルトはヘルプ表示
.DEFAULT_GOAL := help

# -----------------------------------------------------------------------------
# help - コマンド一覧を表示
# -----------------------------------------------------------------------------
help:
	@echo.
	@echo ========================================================
	@echo   X Auto-Post System - Make コマンド一覧
	@echo ========================================================
	@echo.
	@echo   [セットアップ]
	@echo     make setup    : 依存関係をすべてインストール
	@echo     make reset    : クリーン + 再インストール
	@echo     make status   : 環境状態を確認（Node.jsバージョン等）
	@echo.
	@echo   [アプリ起動]
	@echo     make app      : Next.jsアプリを起動（開発モード）
	@echo     make dev      : make app と同じ
	@echo     make run      : make app と同じ
	@echo     make legacy   : レガシー版（Vanilla JS）を起動
	@echo.
	@echo   [ビルド・テスト]
	@echo     make build    : プロダクションビルド
	@echo     make test     : テストを実行
	@echo.
	@echo   [クリーンアップ]
	@echo     make clean    : node_modules を削除
	@echo.
	@echo ========================================================
	@echo   初めての場合: make setup を実行してください
	@echo ========================================================
	@echo.

# -----------------------------------------------------------------------------
# status - 環境状態を確認
# -----------------------------------------------------------------------------
status:
	@echo.
	@echo [環境チェック]
	@echo ----------------------------------------
	@echo Node.js バージョン:
	@node --version 2>nul || echo   ※ Node.js がインストールされていません
	@echo.
	@echo npm バージョン:
	@npm --version 2>nul || echo   ※ npm がインストールされていません
	@echo.
	@echo [インストール状態]
	@echo ----------------------------------------
	@if exist "$(NEXT_APP)\node_modules" (echo   next-app/node_modules: OK) else (echo   next-app/node_modules: 未インストール)
	@echo.

# -----------------------------------------------------------------------------
# setup - 依存関係をインストール
# -----------------------------------------------------------------------------
setup: check-node
	@echo.
	@echo ========================================
	@echo   依存関係をインストール中...
	@echo ========================================
	@echo.
	cd /d "$(NEXT_APP)" && npm install
	@echo.
	@echo ========================================
	@echo   セットアップ完了！
	@echo   「make app」でアプリを起動できます
	@echo ========================================
	@echo.

# -----------------------------------------------------------------------------
# app / dev / run - Next.jsアプリを起動
# -----------------------------------------------------------------------------
app dev run: check-node
	@echo.
	@echo ========================================
	@echo   Next.js アプリを起動中...
	@echo   URL: http://localhost:3000
	@echo   停止: Ctrl + C
	@echo ========================================
	@echo.
	cd /d "$(NEXT_APP)" && npm run dev

# -----------------------------------------------------------------------------
# legacy - レガシー版（Vanilla JS）を起動
# -----------------------------------------------------------------------------
legacy:
	@echo.
	@echo ========================================
	@echo   レガシー版を起動中...
	@echo ========================================
	@echo.
	cd /d "$(ROOT_DIR)" && npm run dev

# -----------------------------------------------------------------------------
# build - プロダクションビルド
# -----------------------------------------------------------------------------
build: check-node
	@echo.
	@echo ========================================
	@echo   プロダクションビルド中...
	@echo ========================================
	@echo.
	cd /d "$(NEXT_APP)" && npm run build

# -----------------------------------------------------------------------------
# test - テスト実行
# -----------------------------------------------------------------------------
test:
	@echo.
	@echo ========================================
	@echo   テストを実行中...
	@echo ========================================
	@echo.
	cd /d "$(ROOT_DIR)" && npm test

# -----------------------------------------------------------------------------
# clean - node_modulesを削除
# -----------------------------------------------------------------------------
clean:
	@echo.
	@echo ========================================
	@echo   クリーンアップ中...
	@echo ========================================
	@echo.
	@if exist "$(NEXT_APP)\node_modules" (rmdir /s /q "$(NEXT_APP)\node_modules" && echo   next-app/node_modules 削除完了) else (echo   next-app/node_modules は存在しません)
	@if exist "$(ROOT_DIR)node_modules" (rmdir /s /q "$(ROOT_DIR)node_modules" && echo   ルート/node_modules 削除完了) else (echo   ルート/node_modules は存在しません)
	@echo.
	@echo   クリーンアップ完了！
	@echo.

# -----------------------------------------------------------------------------
# reset - クリーン + 再インストール
# -----------------------------------------------------------------------------
reset: clean setup
	@echo.
	@echo ========================================
	@echo   リセット完了！
	@echo ========================================
	@echo.

# -----------------------------------------------------------------------------
# check-node - Node.jsがインストールされているか確認
# -----------------------------------------------------------------------------
check-node:
	@node --version >nul 2>&1 || (echo. && echo [エラー] Node.js がインストールされていません && echo https://nodejs.org/ からダウンロードしてください && echo. && exit /b 1)
